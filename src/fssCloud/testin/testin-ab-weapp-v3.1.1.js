function createLocalData(){var e=uuid(),t={version:config.localVersion,clientId:e,apps:{},debugApps:{},timeDown:0,timeUp:0,records:[]};return t}function saveApp(e,t,n){var r;try{r=wx.getStorageSync(config.storageKey)}catch(e){console.log(e)}r&&(n?r.debugApps[e]=t:(r.apps[e]=t,r.timeDown=t.timeDown));try{wx.setStorageSync(config.storageKey,r)}catch(e){console.log(e)}}function ajax(e,t,n){wx.request({url:e,data:t,method:"POST",header:{"content-type":"application/json;charset=UTF-8"},success:function(e){n&&n(null,e.data)},fail:function(e){console.log(e)}})}function reqExp(e,t){function n(t){e._set("data",t),e._set("dataLoaded",!0);var n=e._get("varsData");if(t&&t.exps)for(var r=t.exps,o=0;o<r.length;o++)for(var i in r[o].componentsValues)n[i]=r[o].componentsValues[i];for(var a=e._get("getExperimentsCallback")||[],s=0;s<a.length;s++)a[s]();a.splice(0)}function r(){s.dataTags=JSON.stringify(a),ajax(e._get("url")+config.expUrl,s,function(r,i){var a;r?sendErr(e,{msg:r.msg||r.message}):(0===i.errNo?wx.setStorageSync("testin_first",!1):10001===i.errNo||10003===i.errNo,i.data.timeDown=(new Date).getTime(),a=i.data,e._get("isDebug")?saveApp(e._get("expVersionId"),a,!0):saveApp(e._get("appKey"),a,!1)),o||r||(n(a),t(e._get("vars")))})}var o,i;try{i=wx.getStorageSync(config.storageKey)}catch(e){console.log(e)}i&&(o=e._get("isDebug")?i.debugApps[e._get("expVersionId")]:i.apps[e._get("appKey")],o&&(n(o),t(e._get("vars"))));var a={appKey:e._get("appKey"),testin_id:e._get("clientId"),pl:"weapp",sv:config.sdkVersion,testin_time:(new Date).getTime(),testin_first:!0,vid:"_",di:{testin_av:env.appVersion,testin_ov:env.os.version,testin_pa:config.packageName,testin_lan:env.language,testin_type:"track",testin_model:env.device.model,testin_dw:env.device.screenWidth,testin_dh:env.device.screenHeight,testin_net:"",testin_os:env.deviceType}};wx.getStorageSync("testin_first")===!1?a.testin_first=a.di.testin_isNew=!1:a.testin_first=a.di.testin_isNew=!0;var s={appKey:e._get("appKey"),clientId:e._get("clientId"),appVersion:env.appVersion,sdkVersion:config.sdkVersion,deviceinfo:{osVersionCode:"",osVersion:env.os.version,platform:env.os.name,packageName:config.packageName,language:env.language,country:env.country||"",deviceType:env.deviceType,deviceModel:env.device.model,displayWidth:env.device.screenWidth,displayHeight:env.device.screenHeight,net:""},expVersionId:"0",newPV:!0},c=e._get("tags");if(c)for(var g in c)s.customerLabel=s.customerLabel||{},s.customerLabel[g]=c[g];e._get("isDebug")&&(s.expVersionId=e._get("expVersionId")),wx.getNetworkType({success:function(e){s.deviceinfo.net=a.di.testin_net=e.networkType,r()},fail:function(){r()}})}function ajaxTrack(e,t,n){if(!e._get("localStorageSupported"))return void(n&&n(null));var r;try{r=wx.getStorageSync(config.storageKey),console.log(r)}catch(e){console.log(e)}r.records=r.records.concat(t);try{wx.setStorageSync(config.storageKey,r)}catch(e){console.log(e)}var o;r.records.length<config.maxUploadCount?(o=r.records,r.records=[]):o=r.records.splice(0,config.maxUploadCount),r.timeUp=(new Date).getTime();try{wx.setStorageSync(config.storageKey,r)}catch(e){console.log(e)}var i=parseInt((new Date).getTime()/1e3),a=e._get("appKey"),s={appKey:a,clientId:e._get("clientId"),stime:i,sign:md5(a+i).substring(0,6),debug:e._get("isDebug")?1:0,records:o};ajax(e._get("url")+config.trackUrl,s,function(e,t){n&&n(!e&&t&&0===t.errNo?null:new Error("上报失败"))})}function reqPV(e,t){if(t.varName||t.opName){for(var n,r,o=e._get("data"),i=o&&o.exps||[],a=0;a<i.length;a++)if(i[a].isUpload)if(t.varName){for(var s in i[a].componentsValues)if(s==t.varName&&!e._get("versionPV")[i[a].componentsKey]){e._get("versionPV")[i[a].componentsKey]=!0,n=i[a].expId,r=i[a].componentsKey;break}}else for(var c=i[a].events,g=0;g<c.length;g++)if(c[g]===t.opName&&!e._get("versionPV")[i[a].componentsKey]){e._get("versionPV")[i[a].componentsKey]=!0,n=i[a].expId,r=i[a].componentsKey;break}n&&r&&ajaxTrack(e,[{expId:n,componentsKey:r,metrics:[{name:"PV",count:1,time:parseInt((new Date).getTime()/1e3)}]}])}}function reqTrack(e,t,n){function r(e,t){for(var n=0;n<s.length;n++)if(s[n].expId==e&&s[n].componentsKey==t)return s[n].metrics;return null}function o(e,t){for(var n=0;n<a.length;n++){var o=a[n].events;if(a[n].isUpload)for(var i=0;i<o.length;i++)if(o[i]===e){var c=r(a[n].expId,a[n].componentsKey);return void(c?c.push({name:e,count:t,time:parseInt((new Date).getTime()/1e3)}):s.push({expId:a[n].expId,componentsKey:a[n].componentsKey,metrics:[{name:e,count:t,time:parseInt((new Date).getTime()/1e3)}]}))}}}var i=e._get("data"),a=i&&i.exps||[],s=[];for(var c in t)o(c,t[c]);return s.length?void ajaxTrack(e,s,n):void(n&&n())}function sendErr(e,t){ajax(e._get("url")+config.errUrl,{appKey:e._get("appKey"),clientId:e._get("clientId"),appVersion:env.appVersion,sdkVersion:config.sdkVersion,from:"weapp",platform:env.os.name,platformVersion:env.os.version,model:env.device.model,records:JSON.stringify([{errorTime:parseInt((new Date).getTime()/1e3),errorData:t.msg}])},function(e,t){console.error(e,t)})}function ABTest(){var e=this,t={data:null,isCrawler:!1,appKey:"",clientId:"",isDebug:!1,expVersionId:void 0,defVars:{},varsData:{},versionPV:{},tags:null,timeout:3e3,minTimeout:1e3,url:config.url,dataLoaded:!1,getExperimentsCallback:[],localStorageSupported:!0,vars:{get:function(n,r){return r&&r.noPV||reqPV(e,{varName:n}),t.varsData[n]}}};if(!(this instanceof ABTest))throw new Error("实例化ABTest错误");this._get=function(e){return t[e]},this._set=function(e,n){t[e]=n}}var md5=function(){"use strict";function e(e,t){var n=(65535&e)+(65535&t),r=(e>>16)+(t>>16)+(n>>16);return r<<16|65535&n}function t(e,t){return e<<t|e>>>32-t}function n(n,r,o,i,a,s){return e(t(e(e(r,n),e(i,s)),a),o)}function r(e,t,r,o,i,a,s){return n(t&r|~t&o,e,t,i,a,s)}function o(e,t,r,o,i,a,s){return n(t&o|r&~o,e,t,i,a,s)}function i(e,t,r,o,i,a,s){return n(t^r^o,e,t,i,a,s)}function a(e,t,r,o,i,a,s){return n(r^(t|~o),e,t,i,a,s)}function s(t,n){t[n>>5]|=128<<n%32,t[(n+64>>>9<<4)+14]=n;var s,c,g,p,u,f=1732584193,l=-271733879,d=-1732584194,v=271733878;for(s=0;s<t.length;s+=16)c=f,g=l,p=d,u=v,f=r(f,l,d,v,t[s],7,-680876936),v=r(v,f,l,d,t[s+1],12,-389564586),d=r(d,v,f,l,t[s+2],17,606105819),l=r(l,d,v,f,t[s+3],22,-1044525330),f=r(f,l,d,v,t[s+4],7,-176418897),v=r(v,f,l,d,t[s+5],12,1200080426),d=r(d,v,f,l,t[s+6],17,-1473231341),l=r(l,d,v,f,t[s+7],22,-45705983),f=r(f,l,d,v,t[s+8],7,1770035416),v=r(v,f,l,d,t[s+9],12,-1958414417),d=r(d,v,f,l,t[s+10],17,-42063),l=r(l,d,v,f,t[s+11],22,-1990404162),f=r(f,l,d,v,t[s+12],7,1804603682),v=r(v,f,l,d,t[s+13],12,-40341101),d=r(d,v,f,l,t[s+14],17,-1502002290),l=r(l,d,v,f,t[s+15],22,1236535329),f=o(f,l,d,v,t[s+1],5,-165796510),v=o(v,f,l,d,t[s+6],9,-1069501632),d=o(d,v,f,l,t[s+11],14,643717713),l=o(l,d,v,f,t[s],20,-373897302),f=o(f,l,d,v,t[s+5],5,-701558691),v=o(v,f,l,d,t[s+10],9,38016083),d=o(d,v,f,l,t[s+15],14,-660478335),l=o(l,d,v,f,t[s+4],20,-405537848),f=o(f,l,d,v,t[s+9],5,568446438),v=o(v,f,l,d,t[s+14],9,-1019803690),d=o(d,v,f,l,t[s+3],14,-187363961),l=o(l,d,v,f,t[s+8],20,1163531501),f=o(f,l,d,v,t[s+13],5,-1444681467),v=o(v,f,l,d,t[s+2],9,-51403784),d=o(d,v,f,l,t[s+7],14,1735328473),l=o(l,d,v,f,t[s+12],20,-1926607734),f=i(f,l,d,v,t[s+5],4,-378558),v=i(v,f,l,d,t[s+8],11,-2022574463),d=i(d,v,f,l,t[s+11],16,1839030562),l=i(l,d,v,f,t[s+14],23,-35309556),f=i(f,l,d,v,t[s+1],4,-1530992060),v=i(v,f,l,d,t[s+4],11,1272893353),d=i(d,v,f,l,t[s+7],16,-155497632),l=i(l,d,v,f,t[s+10],23,-1094730640),f=i(f,l,d,v,t[s+13],4,681279174),v=i(v,f,l,d,t[s],11,-358537222),d=i(d,v,f,l,t[s+3],16,-722521979),l=i(l,d,v,f,t[s+6],23,76029189),f=i(f,l,d,v,t[s+9],4,-640364487),v=i(v,f,l,d,t[s+12],11,-421815835),d=i(d,v,f,l,t[s+15],16,530742520),l=i(l,d,v,f,t[s+2],23,-995338651),f=a(f,l,d,v,t[s],6,-198630844),v=a(v,f,l,d,t[s+7],10,1126891415),d=a(d,v,f,l,t[s+14],15,-1416354905),l=a(l,d,v,f,t[s+5],21,-57434055),f=a(f,l,d,v,t[s+12],6,1700485571),v=a(v,f,l,d,t[s+3],10,-1894986606),d=a(d,v,f,l,t[s+10],15,-1051523),l=a(l,d,v,f,t[s+1],21,-2054922799),f=a(f,l,d,v,t[s+8],6,1873313359),v=a(v,f,l,d,t[s+15],10,-30611744),d=a(d,v,f,l,t[s+6],15,-1560198380),l=a(l,d,v,f,t[s+13],21,1309151649),f=a(f,l,d,v,t[s+4],6,-145523070),v=a(v,f,l,d,t[s+11],10,-1120210379),d=a(d,v,f,l,t[s+2],15,718787259),l=a(l,d,v,f,t[s+9],21,-343485551),f=e(f,c),l=e(l,g),d=e(d,p),v=e(v,u);return[f,l,d,v]}function c(e){var t,n="",r=32*e.length;for(t=0;t<r;t+=8)n+=String.fromCharCode(e[t>>5]>>>t%32&255);return n}function g(e){var t,n=[];for(n[(e.length>>2)-1]=void 0,t=0;t<n.length;t+=1)n[t]=0;var r=8*e.length;for(t=0;t<r;t+=8)n[t>>5]|=(255&e.charCodeAt(t/8))<<t%32;return n}function p(e){return c(s(g(e),8*e.length))}function u(e,t){var n,r,o=g(e),i=[],a=[];for(i[15]=a[15]=void 0,o.length>16&&(o=s(o,8*e.length)),n=0;n<16;n+=1)i[n]=909522486^o[n],a[n]=1549556828^o[n];return r=s(i.concat(g(t)),512+8*t.length),c(s(a.concat(r),640))}function f(e){var t,n,r="0123456789abcdef",o="";for(n=0;n<e.length;n+=1)t=e.charCodeAt(n),o+=r.charAt(t>>>4&15)+r.charAt(15&t);return o}function l(e){return unescape(encodeURIComponent(e))}function d(e){return p(l(e))}function v(e){return f(d(e))}function m(e,t){return u(l(e),l(t))}function h(e,t){return f(m(e,t))}function y(e,t,n){return t?n?m(t,e):h(t,e):n?d(e):v(e)}return y}({}),uuid=function(){function e(){var e=(new Date).getTime();e%=16,e=e.toString(16);var t=Math.floor(65536*(1+Math.random())).toString(16).substring(1),n=parseInt(4*Math.random()),r=t.split("");return r[n]=e,r.join("")}var t=""+(new Date).getTime();return e()+e()+"-"+e()+"-"+e()+"-"+e()+"-"+t.substring(1)},config,env;!function(){config={storageKey:"testinABWeAppStorage",localVersion:"v1.0.3",url:"https://abapi.testin.cn",expUrl:"/abtest-api/api/getexperiment",trackUrl:"/abtest-api/api/sendlog",errUrl:"/abtest-api/api/senderrorlog",packageName:"cn.testin.ab.weapp",sdkVersion:"v3.1.1",asyncTime:20,maxUploadCount:10}}(),function(){env={};try{var e=wx.getSystemInfoSync(),t=e.system.split(" ");env.os={name:t[0].toLocaleLowerCase(),version:t[1].toLocaleLowerCase()},env.language=e.language,env.weAppSDKVersion=e.SDKVersion,env.appVersion="_",env.device={screenWidth:e.screenWidth,screenHeight:e.screenHeight,model:e.model},env.deviceType=e.platform}catch(e){env.os={},env.device={},env.language="",env.country="",env.weAppSDKVersion="",env.appVersion="_"}}(),ABTest.prototype={constructor:ABTest,init:function(e,t){var n=this;if(!e)throw new Error("appKey required");var r;try{r=wx.getStorageSync(config.storageKey)}catch(e){console.log(e)}if(!r||r.version!=config.localVersion){r=createLocalData();try{wx.setStorageSync(config.storageKey,r)}catch(e){console.log(e)}}t||(t=r.clientId),n._set("appKey",e),n._set("clientId",t)},setDefVars:function(e){var t=this._get("defVars"),n=this._get("varsData");for(var r in e)t[r]=e[r],n[r]=e[r]},setTags:function(e){var t={};for(var n in e)"string"==typeof e[n]?t[n]="'"+e[n]+"'":t[n]=e[n];this._set("tags",t)},setTimeout:function(e){return isNaN(e)||e<this._get("minTimeout")?this._set("timeout",this._get("minTimeout")):void this._set("timeout",e)},setUrl:function(e){"/"==e.substr(e.length-1)&&(e=e.substr(0,e.length-1)),this._set("url",e)},getVars:function(e){function t(t){o||(o=!0,setTimeout(function(){e&&e(t)},config.asyncTime))}var n={useCache:!0};if(e=e||function(){},!this._get("appKey"))throw new Error("请先调用init方法设置appKey");var r=this,o=!1;this._get("localStorageSupported")?(setTimeout(function(){t(r._get("vars"))},this._get("timeout")),reqExp(this,t,n.useCache)):t(this._get("vars"))},getExperiments:function(e){function t(){setTimeout(function(){var t=n._get("data");t=t||{};for(var r=t.exps||[],o=[],i="CONTROL",a=0;a<r.length;a++){var s={layerId:r[a].layerId,layerName:r[a].layerName,expId:r[a].expId,expName:r[a].expName,expVersionId:r[a].componentsKey,expVersionName:r[a].expVersionName};r[a].componentsKey||(s.expId=i,s.expName=i,s.expVersionId=i,s.expVersionName=i),o.push(s)}e(o)},config.asyncTime)}var n=this;if(this._get("localStorageSupported"))if(this._get("dataLoaded"))t();else{var r=this._get("getExperimentsCallback");r.push(t)}else t()},track:function(){function e(){t&&(i||(i=!0,setTimeout(function(){t()},config.asyncTime)))}var t,n=arguments,r={};if("string"==typeof n[0]){if(!n[1]||"function"==typeof n[1])return;r[n[0]]=n[1],3==n.length&&(t=n[2])}else{for(var o in n[0])n[0][o]&&(r[o]=n[0][o]);2==n.length&&(t=n[1])}var i=!1;if(!this._get("localStorageSupported"))return e();if(!this._get("dataLoaded"))return e();setTimeout(function(){e()},this._get("timeout"));for(var a in r)reqPV(this,{opName:a});reqTrack(this,r,e)},getVersion:function(){return config.sdkVersion}},module.exports=new ABTest;